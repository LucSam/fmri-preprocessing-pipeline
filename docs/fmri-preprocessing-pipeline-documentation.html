<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.4">
  <style type="text/css">
    p.p2 {margin: 0.0px 0.0px 14.4px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d}
    p.p3 {margin: 0.0px 0.0px 14.4px 0.0px; font: 12.0px Menlo; color: #1d1d1d; -webkit-text-stroke: #1d1d1d; background-color: #efefef}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 10.8px Monaco; color: #1d1d1d; -webkit-text-stroke: #1d1d1d; background-color: #efefef}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 10.8px Monaco; color: #1d1d1d; -webkit-text-stroke: #1d1d1d}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 10.8px Monaco; color: #1d1d1d; -webkit-text-stroke: #1d1d1d; background-color: #efefef; min-height: 15.0px}
    li.li4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d}
    li.li8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 10.8px Monaco; color: #1d1d1d; -webkit-text-stroke: #1d1d1d}
    span.s1 {font-kerning: none}
    span.s2 {-webkit-text-stroke: 0px #000000}
    span.s3 {font-kerning: none; background-color: #efefef}
    span.s4 {font: 12.0px 'Helvetica Neue'; font-kerning: none}
    span.s5 {font: 10.8px Monaco; font-kerning: none; background-color: #efefef}
    span.s6 {font: 12.0px 'Helvetica Neue'; -webkit-text-stroke: 0px #000000}
    table.t1 {margin: 24.0px 0.0px 24.0px 0.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; border-collapse: collapse}
    td.td1 {width: 44.6px; background-color: #ebebeb; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 12.0px 12.0px 12.0px 12.0px}
    td.td2 {width: 353.7px; background-color: #ebebeb; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 12.0px 12.0px 12.0px 12.0px}
    td.td3 {width: 270.8px; background-color: #ebebeb; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 12.0px 12.0px 12.0px 12.0px}
    td.td4 {width: 48.6px; background-color: #f5f5f5; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    td.td5 {width: 357.7px; background-color: #f5f5f5; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    td.td6 {width: 274.8px; background-color: #f5f5f5; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    td.td7 {width: 48.6px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    td.td8 {width: 357.7px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    td.td9 {width: 274.8px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cbcbcb #cbcbcb #cbcbcb #cbcbcb; padding: 10.0px 10.0px 10.0px 10.0px}
    ol.ol1 {list-style-type: decimal}
    ul.ul1 {list-style-type: disc}
    ul.ul2 {list-style-type: circle}
  </style>
</head>
<body>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Citation</b><b></b></span></h2>
<p class="p2"><span class="s1">If you use this pipeline in your research, please cite:</span></p>
<p class="p3"><span class="s1">Fekonja, L., &amp; Karatay, O. (2025). fMRI Preprocessing Pipeline (Version 1.0) [Computer software].</span></p>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Acknowledgments</b><b></b></span></h2>
<p class="p2"><span class="s1">This pipeline integrates and builds upon several neuroimaging tools:</span></p>
<ul class="ul1">
  <li class="li4"><span class="s2"></span><span class="s1">FSL (FMRIB Software Library)</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">ANTs (Advanced Normalization Tools)</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">MRtrix3</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">ICA-AROMA</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">CompCor denoising algorithm</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">FreeSurfer (including SynthSeg)</span></li>
  <li class="li4"><span class="s2"></span><span class="s1">Python libraries: nibabel, nilearn, ANTsPy, ANTsPyNet, and more</span></li>
</ul>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Contact</b><b></b></span></h2>
<p class="p2"><span class="s1">For questions, feedback, or support, please contact:</span></p>
<p class="p2"><span class="s1"><b>Authors:</b> Lucius Fekonja, Onurhan Karatay</span></p>
<h1 style="margin: 0.0px 0.0px 15.0px 0.0px; font: 30.0px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>fMRI Preprocessing Pipeline</b><b></b></span></h1>
<p class="p2"><span class="s1"><b>Version:</b> 1.0<br>
<b>Authors:</b> Lucius Fekonja, Onurhan Karatay<br>
<b>Last Updated:</b> March 2025</span></p>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Overview</b><b></b></span></h2>
<p class="p2"><span class="s1">This pipeline provides a comprehensive set of tools for preprocessing functional MRI (fMRI) data. It includes distortion correction, motion correction, advanced denoising techniques (ICA-AROMA and CompCor), and functional connectivity matrix creation, making it suitable for both clinical and research applications.</span></p>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Features</b><b></b></span></h2>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>DICOM to NIfTI conversion</b> using MRtrix3</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Distortion correction</b> using FSL's TOPUP</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Motion correction</b> using FSL's MCFLIRT</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Brain extraction</b> using ANTsPyNet</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>T1 to fMRI registration</b> using ANTs</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Tissue segmentation</b> using choice of ANTs Deep Atropos or FreeSurfer SynthSeg</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Atlas registration</b> with support for AAL, Schaefer, and FreeSurfer parcellations</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA-based denoising</b> with MELODIC and ICA-AROMA</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>CompCor denoising</b> with optional bandpass filtering</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Functional connectivity matrix creation</b><b></b></span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Extensive quality control visualizations</b><b></b></span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Detailed HTML and text summary reports</b><b></b></span></li>
</ul>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Software Requirements</b><b></b></span></h2>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Required Software</b><b></b></span></h3>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>FSL</b> (FMRIB Software Library)</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>MRtrix3</b><b></b></span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ANTs</b> (Advanced Normalization Tools)</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Python 3</b> with the following packages:</span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">nibabel</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">numpy</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">nilearn</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">scikit-learn</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">scipy</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">matplotlib</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">seaborn</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">pandas</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA-AROMA</b><b></b></span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>FreeSurfer</b> (required for FreeSurfer atlas or SynthSeg segmentation)</span></li>
</ul>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Optional Software</b><b></b></span></h3>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ANTsPy</b> and <b>ANTsPyNet</b> for Deep Atropos segmentation and improved brain extraction</span></li>
</ul>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Input Data Requirements</b><b></b></span></h2>
<p class="p2"><span class="s1">The script expects the following input data:</span></p>
<ol class="ol1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>DICOM directories</b> for:</span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Spin Echo Field Map (Anterior-Posterior)</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Spin Echo Field Map (Posterior-Anterior)</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Two fMRI REST scans (Anterior-Posterior)</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>T1-weighted structural image</b> in NIfTI format</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Atlas file</b> (depending on the selected atlas type):</span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">AAL atlas</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Schaefer atlas</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">FreeSurfer output directory (if using FreeSurfer)</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Lesion mask</b> (optional) in NIfTI format</span></li>
</ol>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Usage</b><b></b></span></h2>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Basic Command</b><b></b></span></h3>
<p class="p7"><span class="s1">./fmri_preprocessing.sh -s /path/to/subject \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-A aal -a /path/to/AAL.nii \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-t /path/to/t1.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-S atropos \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-I /path/to/ICA-AROMA.py \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-C 1 -N 5 -B 1 -L 0.08 -H 0.01</span></p>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Command Line Options</b><b></b></span></h3>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td1">
        <p class="p4"><span class="s1"><b>Option</b></span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p4"><span class="s1"><b>Description</b></span></p>
      </td>
      <td valign="middle" class="td3">
        <p class="p4"><span class="s1"><b>Required</b></span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-s</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Subject directory path</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">No (defaults to current directory)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-o</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Output directory path</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p8"><span class="s4">No (defaults to </span><span class="s3">SUBJECT_DIR/preprocessed</span><span class="s4">)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-d</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">DICOM directories (comma-separated)</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">Yes</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-A</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Atlas type: 'aal', 'schaefer', or 'freesurfer'</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">No (defaults to 'aal')</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-a</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Path to atlas file (required for 'aal' and 'schaefer')</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">Conditional</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-t</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Path to T1 image</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">Yes</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-l</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Path to lesion mask</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">No</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-f</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Path to FreeSurfer subject directory (for 'freesurfer' atlas)</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">Conditional</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-I</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Path to ICA-AROMA.py</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">Yes</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-S</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Segmentation method: 'atropos' or 'synthseg'</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">No (defaults to 'atropos')</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-C</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Enable CompCor denoising: 0=disabled, 1=enabled</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">No (defaults to 0)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-N</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Number of CompCor components to extract</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">No (defaults to 5)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-B</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Apply bandpass filter with CompCor: 0=disabled, 1=enabled</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">No (defaults to 1)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-L</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Lowpass filter cutoff in Hz</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">No (defaults to 0.08)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td4">
        <p class="p8"><span class="s3">-H</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p4"><span class="s1">Highpass filter cutoff in Hz</span></p>
      </td>
      <td valign="middle" class="td6">
        <p class="p4"><span class="s1">No (defaults to 0.01)</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td7">
        <p class="p8"><span class="s3">-h</span></p>
      </td>
      <td valign="middle" class="td8">
        <p class="p4"><span class="s1">Display help message</span></p>
      </td>
      <td valign="middle" class="td9">
        <p class="p4"><span class="s1">No</span></p>
      </td>
    </tr>
  </tbody>
</table>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Example Commands</b><b></b></span></h3>
<h4 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d"><span class="s1"><b>Using AAL Atlas with Deep Atropos segmentation and CompCor</b></span></h4>
<p class="p7"><span class="s1">./fmri_preprocessing15_5.sh -s /path/to/subject \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-A aal -a /path/to/AAL.nii \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-t /path/to/t1.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-S atropos \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-I /path/to/ICA-AROMA.py \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-C 1 -N 5 -B 1 -L 0.08 -H 0.01</span></p>
<h4 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d"><span class="s1"><b>Using Schaefer Atlas with SynthSeg segmentation (without CompCor)</b></span></h4>
<p class="p7"><span class="s1">./fmri_preprocessing15_5.sh -s /path/to/subject \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-A schaefer -a /path/to/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-t /path/to/t1.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-S synthseg \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-I /path/to/ICA-AROMA.py</span></p>
<h4 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d"><span class="s1"><b>Using FreeSurfer Atlas</b></span></h4>
<p class="p7"><span class="s1">./fmri_preprocessing15_5.sh -s /path/to/subject \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-A freesurfer \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-t /path/to/t1.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-f /path/to/freesurfer_subj_dir \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-I /path/to/ICA-AROMA.py</span></p>
<h4 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 12.0px 'Helvetica Neue'; color: #1d1d1d; -webkit-text-stroke: #1d1d1d"><span class="s1"><b>Including Lesion Mask with CompCor Denoising</b></span></h4>
<p class="p7"><span class="s1">./fmri_preprocessing15_5.sh -s /path/to/subject \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-A aal -a /path/to/AAL.nii \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-t /path/to/t1.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-l /path/to/lesion.nii.gz \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-I /path/to/ICA-AROMA.py \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>-C 1 -N 8 -B 1 -L 0.08 -H 0.01</span></p>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Processing Steps</b><b></b></span></h2>
<ol class="ol1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Dependency and input validation</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Checks for required software and validates input files</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>DICOM to NIfTI conversion</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Converts DICOM images to NIfTI format using MRtrix3</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Extracts metadata (e.g., TR, phase encoding directions)</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>TOPUP distortion correction</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Generates TOPUP encoding file</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Runs TOPUP to estimate susceptibility-induced distortions</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Applies correction to fMRI data</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Motion correction</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Applies MCFLIRT to correct for head motion</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Generates motion parameters, FD metrics, and QC plots</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Creates motion confounds file</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Brain extraction</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Extracts a 3D volume from the 4D fMRI</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Applies ANTsPyNet brain extraction</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Creates brain mask and applies it to 4D fMRI</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>T1 to fMRI registration</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Adjusts strides of T1 image</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Registers T1 to fMRI space</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Transforms lesion mask (if provided)</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Tissue segmentation</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Uses selected segmentation method (Deep Atropos or SynthSeg)</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Generates probability maps for CSF, GM, and WM</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Transforms segmentation results to fMRI space</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Atlas registration</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Registers selected atlas to fMRI space</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Transforms FreeSurfer parcellation (if selected)</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA analysis and denoising</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Runs MELODIC ICA</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Performs ICA-AROMA to identify and remove motion components</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Generates QC visualizations for component classification</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>CompCor denoising (optional)</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Extracts noise components from WM and CSF regions</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Regresses out noise components and motion parameters</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Applies bandpass filtering if enabled</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Generates CompCor QC visualizations</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Carpet plot generation</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Creates carpet plot for quality assessment</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Shows voxel-wise time series data by tissue type</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Connectivity analysis</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Extracts time series from atlas regions</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Calculates Pearson, Spearman, and partial correlations</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Generates connectivity matrices and visualizations</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Creates Z-normalized connectivity matrices</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Report generation</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Creates detailed HTML summary report</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Provides text-based summary report</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Includes comprehensive file listings</span></li>
  </ul>
</ol>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Output Structure</b><b></b></span></h2>
<p class="p2"><span class="s1">After running the pipeline, the following directory structure is created:</span></p>
<p class="p7"><span class="s1">preprocessed/</span></p>
<p class="p7"><span class="s1">├── nifti/ <span class="Apple-converted-space">                      </span># Converted NIfTI files and JSON metadata</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── 010_SpinEchoFieldMap_AP.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── 011_SpinEchoFieldMap_PA.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── 012_rfMRI_REST_AP.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── 013_rfMRI_REST_AP.nii.gz</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── registration/<span class="Apple-converted-space">                </span># Registration-related files</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── fmri_3d.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── fmri_brain.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── fmri_brain_mask.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── t1_in_fmri_space.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── t1_brain_segmentation*.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── csf_prob.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── gm_prob.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── wm_prob.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── topup_*</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── atlas_registered_to_fmri.nii.gz</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── motion_correction/ <span class="Apple-converted-space">          </span># Motion correction results</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── mcflirt_corrected_fmri.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── mcflirt_corrected_fmri.par</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── fd_metrics.txt</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── motion_confounds.txt</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── melodic.ica/ <span class="Apple-converted-space">                </span># MELODIC ICA results</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── melodic_IC.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── melodic_mix</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── report/</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── ICA_AROMA/ <span class="Apple-converted-space">                  </span># ICA-AROMA denoising results</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── denoised_func_data_nonaggr.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── denoised_func_data_aggr.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── classified_motion_ICs.txt</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── compcor/ <span class="Apple-converted-space">                    </span># CompCor denoising results (if enabled)</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── compcor_cleaned.nii.gz</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── acompcor_components.txt</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── QC/</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── connectivity/<span class="Apple-converted-space">                </span># Connectivity analysis results</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── functional_connectivity_matrix_*.txt</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── valid_regions.csv</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── synthseg/<span class="Apple-converted-space">                    </span># SynthSeg results (if used)</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── segmentation.nii.gz</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── QC/<span class="Apple-converted-space">                          </span># Quality control visualizations</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── rot_motion.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── trans_motion.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── combined_motion.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── ica_aroma_classification.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── carpet_plot_simple.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>├── functional_connectivity_matrices.png</span></p>
<p class="p7"><span class="s1">│ <span class="Apple-converted-space">  </span>└── connectivity_distributions.png</span></p>
<p class="p7"><span class="s1">│</span></p>
<p class="p7"><span class="s1">├── preprocessing.log<span class="Apple-converted-space">            </span># Processing log</span></p>
<p class="p7"><span class="s1">├── preprocessing_timestamp.log<span class="Apple-converted-space">  </span># Backup log file</span></p>
<p class="p7"><span class="s1">├── summary_report.html<span class="Apple-converted-space">          </span># HTML summary report</span></p>
<p class="p7"><span class="s1">└── summary_report.txt <span class="Apple-converted-space">          </span># Text summary report</span></p>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Key Output Files</b><b></b></span></h2>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Preprocessed Data</b><b></b></span></h3>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA-AROMA Denoised fMRI (Non-aggressive):</b> </span><span class="s5">ICA_AROMA/denoised_func_data_nonaggr.nii.gz</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA-AROMA Denoised fMRI (Aggressive):</b> </span><span class="s5">ICA_AROMA/denoised_func_data_aggr.nii.gz</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>CompCor Denoised fMRI:</b> </span><span class="s3">compcor/compcor_cleaned.nii.gz</span><span class="s4"> (if CompCor enabled)</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Brain-Extracted fMRI:</b> </span><span class="s3">registration/mcflirt_corrected_fmri_brain.nii.gz</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>T1 in fMRI Space:</b> </span><span class="s3">registration/t1_in_fmri_space.nii.gz</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Atlas in fMRI Space:</b> </span><span class="s3">registration/atlas_registered_to_fmri.nii.gz</span></li>
</ul>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Connectivity Results</b><b></b></span></h3>
<ul class="ul1">
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Pearson Correlation Matrix:</b> </span><span class="s3">connectivity/functional_connectivity_matrix_pearson.txt</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Spearman Correlation Matrix:</b> </span><span class="s3">connectivity/functional_connectivity_matrix_spearman.txt</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Partial Correlation Matrix:</b> </span><span class="s3">connectivity/functional_connectivity_matrix_partial.txt</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Z-normalized Matrices:</b> </span><span class="s3">connectivity/functional_connectivity_matrix_*_znorm.txt</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>CompCor Correlation Matrices:</b> </span><span class="s3">connectivity/functional_connectivity_matrix_compcor_*.txt</span><span class="s4"> (if CompCor enabled)</span></li>
</ul>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Quality Control</b><b></b></span></h3>
<ul class="ul1">
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Motion Parameters:</b> </span><span class="s3">motion_correction/mcflirt_corrected_fmri.par</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Framewise Displacement:</b> </span><span class="s3">motion_correction/fd_metrics.txt</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Motion Plots:</b> </span><span class="s3">QC/rot_motion.png</span><span class="s4">, </span><span class="s3">QC/trans_motion.png</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>ICA-AROMA Classification:</b> </span><span class="s3">QC/ica_aroma_classification.png</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Carpet Plot:</b> </span><span class="s3">QC/carpet_plot_simple.png</span><span class="s4"> or </span><span class="s3">compcor/QC/carpet_denoised.png</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>Connectivity Visualizations:</b> </span><span class="s3">QC/functional_connectivity_matrices.png</span></li>
  <li class="li8"><span class="s6"><b></b></span><span class="s4"><b>CompCor QC:</b> </span><span class="s3">compcor/QC/variance_explained.png</span><span class="s4">, </span><span class="s3">compcor/QC/connectivity_matrices_comparison.png</span><span class="s4"> (if CompCor enabled)</span></li>
</ul>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Reports</b><b></b></span></h3>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>HTML Summary Report:</b> </span><span class="s5">summary_report.html</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Text Summary Report:</b> </span><span class="s5">summary_report.txt</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Processing Log:</b> </span><span class="s5">preprocessing.log</span></li>
</ul>
<h2 style="margin: 0.0px 0.0px 16.2px 0.0px; font: 21.6px 'Helvetica Neue'; color: #192330; -webkit-text-stroke: #192330"><span class="s1"><b>Customization</b><b></b></span></h2>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Advanced Options</b><b></b></span></h3>
<p class="p2"><span class="s1">The script offers several advanced customization options:</span></p>
<ul class="ul1">
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Segmentation method selection:</b> Choose between </span><span class="s5">atropos</span><span class="s1"> (Deep Atropos with ANTsPyNet) and </span><span class="s5">synthseg</span><span class="s1"> (FreeSurfer SynthSeg)</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>CompCor parameters:</b><b></b></span></li>
  <ul class="ul2">
    <li class="li4"><span class="s2"></span><span class="s1">Enable/disable CompCor denoising with the </span><span class="s5">-C</span><span class="s1"> option</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Adjust number of components with </span><span class="s5">-N</span><span class="s1"> option</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Enable/disable bandpass filtering with </span><span class="s5">-B</span><span class="s1"> option</span></li>
    <li class="li4"><span class="s2"></span><span class="s1">Set custom filter frequencies with </span><span class="s5">-L</span><span class="s1"> and </span><span class="s5">-H</span><span class="s1"> options</span></li>
  </ul>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>MELODIC component count:</b> Modify the </span><span class="s5">--dim=30</span><span class="s1"> parameter in the MELODIC call</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>ICA-AROMA denoising approach:</b> Use non-aggressive (</span><span class="s5">nonaggr</span><span class="s1">) denoising for connectivity analysis</span></li>
  <li class="li4"><span class="s2"><b></b></span><span class="s1"><b>Atlas registration approach:</b> Adjust the </span><span class="s5">-t s</span><span class="s1"> parameter in the ANTs registration call</span></li>
</ul>
<h3 style="margin: 0.0px 0.0px 15.6px 0.0px; font: 15.6px 'Helvetica Neue'; color: #236ec7; -webkit-text-stroke: #236ec7"><span class="s1"><b>Processing Multiple Subjects</b><b></b></span></h3>
<p class="p2"><span class="s1">For batch processing of multiple subjects, create a wrapper script:</span></p>
<p class="p7"><span class="s1">#!/bin/bash</span></p>
<p class="p10"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"># Set paths</span></p>
<p class="p7"><span class="s1">ATLAS_FILE="/path/to/atlas.nii"</span></p>
<p class="p7"><span class="s1">T1_DIR="/path/to/t1_images"</span></p>
<p class="p7"><span class="s1">SUBJECT_DIR="/path/to/subjects"</span></p>
<p class="p7"><span class="s1">ICA_AROMA_DIR="/path/to/ICA-AROMA.py"</span></p>
<p class="p10"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"># Set processing options</span></p>
<p class="p7"><span class="s1">SEGMENTATION_TYPE="atropos"<span class="Apple-converted-space">  </span># or "synthseg"</span></p>
<p class="p7"><span class="s1">ENABLE_COMPCOR=1<span class="Apple-converted-space">  </span># 1=enabled, 0=disabled</span></p>
<p class="p7"><span class="s1">COMPCOR_COMPONENTS=5</span></p>
<p class="p7"><span class="s1">BANDPASS_FILTER=1<span class="Apple-converted-space">  </span># 1=enabled, 0=disabled</span></p>
<p class="p7"><span class="s1">LOWPASS_HZ=0.08</span></p>
<p class="p7"><span class="s1">HIGHPASS_HZ=0.01</span></p>
<p class="p10"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"># Process each subject</span></p>
<p class="p7"><span class="s1">for subject in $(ls $SUBJECT_DIR); do</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>echo "Processing subject: $subject"</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span>./fmri_preprocessing.sh \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-s "$SUBJECT_DIR/$subject" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-d "010_SpinEchoFieldMap_AP,011_SpinEchoFieldMap_PA,012_rfMRI_REST_AP,013_rfMRI_REST_AP" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-A aal -a "$ATLAS_FILE" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-t "$T1_DIR/${subject}_t1.nii.gz" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-I "$ICA_AROMA_DIR" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-S "$SEGMENTATION_TYPE" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-C "$ENABLE_COMPCOR" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-N "$COMPCOR_COMPONENTS" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-B "$BANDPASS_FILTER" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-L "$LOWPASS_HZ" \</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>-H "$HIGHPASS_HZ"</span></p>
<p class="p7"><span class="s1">done</span></p>
</body>
</html>
